<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Supervision ‚Äì Variables process</title>
    <link rel="stylesheet" href="style-dashboard.css">

    <!-- Protection login -->
    <script>
        if (localStorage.getItem("loggedIn") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>

<body class="dash-body">

    <!-- Sidebar gauche -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">üß∞</span>
            <span class="sidebar-logo-text">SUPERVISION</span>
        </div>

        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item active">üìä <span>Temps r√©el</span></a>
            <a href="config.html" class="sidebar-item">‚öôÔ∏è <span>Param√©trage</span></a>
            <a href="historique.html" class="sidebar-item">üìÖ <span>Historique</span></a>
            <a href="#" class="sidebar-item">üö® <span>Alarmes</span></a>
        </nav>

        <button class="sidebar-logout" onclick="logout()">D√©connexion</button>
    </aside>

    <!-- Zone principale -->
    <div class="main-layout">

        <!-- Bandeau haut -->
        <header class="topbar">
            <div>
                <h1>Supervision des variables process</h1>
                <p>TP ‚Äì D√©ploiement d‚Äôun SI (Node / MariaDB / Docker)</p>
            </div>
            <div class="topbar-right">
                <div class="topbar-badges">
                    <span class="badge badge-ok">Backend OK</span>
                    <span class="badge badge-ok">MariaDB OK</span>
                    <span class="badge badge-warn">Modbus simul√©</span>
                </div>
                <div class="topbar-clock">
                    <span id="clock-time">--:--</span>
                    <span id="clock-date">--/--/----</span>
                </div>
            </div>
        </header>

        <!-- Grille principale adapt√©e au TP -->
        <main class="grid grid-tp">

            <!-- Liste des variables -->
            <section class="card vars-card">
                <h2>Variables surveill√©es</h2>
                
                <table class="vars-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>IP automate</th>
                            <th>Registre</th>
                            <th>Fr√©q. (s)</th>
                            <th>Derni√®re valeur</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="vars-body">
                        <!-- Exemple de lignes (remplac√©es plus tard par le backend) -->
                        <tr class="row-selected">
                            <td>Temp√©rature four</td>
                            <td>192.168.0.10</td>
                            <td>40001</td>
                            <td>5</td>
                            <td>182.4 ¬∞C</td>
                            <td><span class="pill ok">OK</span></td>
                        </tr>
                        <tr>
                            <td>Pression ligne</td>
                            <td>192.168.0.11</td>
                            <td>30002</td>
                            <td>2</td>
                            <td>6.2 bar</td>
                            <td><span class="pill warn">SEUIL</span></td>
                        </tr>
                        <tr>
                            <td>Moteur convoyeur</td>
                            <td>192.168.0.12</td>
                            <td>00013</td>
                            <td>1</td>
                            <td>ON</td>
                            <td><span class="pill err">FAULT</span></td>
                        </tr>
                    </tbody>
                </table>

                <div class="vars-footer">
                    <button class="btn-link" onclick="window.location.href='config.html'">
                        ‚öôÔ∏è G√©rer les variables
                    </button>
                </div>
            </section>

            <!-- Graph temps r√©el -->
            <section class="card realtime-card">
                <div class="realtime-header">
                    <div>
                        <h2>Temps r√©el ‚Äì <span id="rt-var-name">Temp√©rature four</span></h2>
                        <p>Derni√®res 2 minutes (rafra√Æchissement p√©riodique c√¥t√© backend)</p>
                    </div>
                    <div class="rt-current">
                        <span class="label">Derni√®re valeur</span>
                        <span class="rt-value" id="rt-value">182.4 ¬∞C</span>
                        <span class="rt-timestamp" id="rt-timestamp">√† 16:29:12</span>
                    </div>
                </div>

                <div class="trend-placeholder">
                    <!-- Tu pourras remplacer ce div par un <canvas id="rtChart"></canvas> pour Chart.js -->
                    <span>Graphique temps r√©el (Chart.js ici)</span>
                </div>
            </section>

            <!-- Cartes de synth√®se -->
            <section class="card summary-card">
                <h2>R√©sum√© supervision</h2>

                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Variables actives</span>
                        <span class="value big" id="sum-active">3</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Variables en seuil</span>
                        <span class="value big warn" id="sum-warn">1</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Variables en d√©faut</span>
                        <span class="value big err" id="sum-err">1</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Total mesures / h</span>
                        <span class="value big" id="sum-rate">720</span>
                    </div>
                </div>

                <div class="summary-footer">
                    <button class="btn-link" onclick="window.location.href='historique.html'">
                        üìÖ Voir historique & export CSV
                    </button>
                </div>
            </section>

        </main>

    </div>

<script>
    const API_URL = "http://localhost:3000/api";

    // Rafra√Æchir les donn√©es toutes les 2 secondes
    setInterval(updateDashboard, 2000);
    updateDashboard();

    async function updateDashboard() {
        try {
            const response = await fetch(`${API_URL}/dashboard`);
            const data = await response.json();
            const tbody = document.getElementById("vars-body");
            tbody.innerHTML = "";

            // KPIs
            let activeCount = 0;
            let warnCount = 0;

            data.forEach(item => {
                activeCount++;
                let statusClass = "ok";
                let statusText = "OK";
                
                // Simulation simple d'un seuil (ex: si valeur > 80)
                if(item.valeur > 80) {
                    statusClass = "warn";
                    statusText = "SEUIL";
                    warnCount++;
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.nom}</td>
                    <td>${item.ip}</td>
                    <td>${item.registre}</td>
                    <td>${item.frequence}</td>
                    <td>${item.valeur !== null ? parseFloat(item.valeur).toFixed(2) : '--'}</td>
                    <td><span class="pill ${statusClass}">${statusText}</span></td>
                `;
                
                // Clic pour mise √† jour d√©tail (partie droite)
                tr.onclick = () => updateDetail(item);
                tbody.appendChild(tr);
            });

            // Mise √† jour des cartes r√©sum√©
            document.getElementById("sum-active").textContent = activeCount;
            document.getElementById("sum-warn").textContent = warnCount;

        } catch (e) {
            console.error("Erreur connexion backend", e);
        }
    }

    function updateDetail(item) {
        document.getElementById("rt-var-name").textContent = item.nom;
        document.getElementById("rt-value").textContent = item.valeur;
        document.getElementById("rt-timestamp").textContent = new Date(item.timestamp).toLocaleTimeString();
    }

    // Horloge existante
    function updateClock() {
        const now = new Date();
        document.getElementById('clock-time').textContent = now.toLocaleTimeString('fr-FR');
        document.getElementById('clock-date').textContent = now.toLocaleDateString('fr-FR');
    }
    setInterval(updateClock, 1000);
    function logout() { localStorage.removeItem("loggedIn"); window.location.href = "login.html"; }
</script>

</body>
</html>
