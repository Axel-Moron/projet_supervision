<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision ‚Äì Variables process</title>
    <link rel="stylesheet" href="style-dashboard.css?v=1.5">

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="auth.js?v=1.5"></script>
</head>

<body class="dash-body">

    <aside class="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">üß∞</span>
            <span class="sidebar-logo-text">SUPERVISION</span>
        </div>

        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item active">üìä <span>Temps r√©el</span></a>
            <a href="config.html" class="sidebar-item">‚öôÔ∏è <span>Param√©trage</span></a>
            <a href="historique.html" class="sidebar-item">üìÖ <span>Historique</span></a>
        </nav>
    </aside>

    <div class="main-layout">

        <header class="topbar">
            <div>
                <h1>Supervision des variables process</h1>
                <p>√âtat en temps r√©el de l'installation</p>
            </div>

            <div class="topbar-right">
                <div class="topbar-badges">
                    <span id="backend-badge" class="badge badge-ok">Backend OK</span>

                    <div class="mode-container">
                        <span id="mode-label" class="mode-label">MODBUS R√âEL</span>
                        <label class="switch">
                            <input type="checkbox" id="mode-switch" name="mode-switch" onchange="toggleMode()"
                                aria-label="Basculer entre mode r√©el et simulation">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <div class="topbar-clock">
                    <span id="clock-time">--:--</span>
                    <span id="clock-date">--/--/----</span>
                </div>
            </div>
        </header>

        <main class="grid grid-tp">

            <section class="card vars-card">
                <h2>Variables surveill√©es</h2>

                <table class="vars-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>IP automate</th>
                            <th>Registre</th>
                            <th>Valeur</th>
                            <th>√âtat</th>
                        </tr>
                    </thead>
                    <tbody id="vars-body">
                        <tr>
                            <td colspan="5" class="empty-message">Connexion au serveur...</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="card realtime-card">
                <div class="realtime-header">
                    <div>
                        <h2>D√©tails ‚Äì <span id="rt-var-name">...</span></h2>
                        <p>S√©lectionnez une ligne pour voir l'historique r√©cent</p>
                    </div>
                    <div class="rt-current">
                        <span class="label">Derni√®re lecture</span>
                        <span class="rt-value" id="rt-value">--</span>
                        <span class="rt-timestamp" id="rt-timestamp">--:--:--</span>
                    </div>
                </div>

                <!-- Quick Ranges for Dashboard -->
                <div class="quick-ranges quick-ranges-dashboard">
                    <button type="button" class="btn-small" onclick="loadHistoryForDashboard(5)">5 min</button>
                    <button type="button" class="btn-small" onclick="loadHistoryForDashboard(10)">10 min</button>
                    <button type="button" class="btn-small" onclick="loadHistoryForDashboard(60)">1 h</button>
                    <button type="button" class="btn-small" onclick="loadHistoryForDashboard(240)">4 h</button>
                    <button type="button" class="btn-small" onclick="loadHistoryForDashboard(1440)">24 h</button>
                    <button type="button" class="btn-small btn-period" onclick="toggleCustomPeriod()">üìÖ
                        P√©riode</button>
                </div>

                <!-- Custom Period Inputs (Hidden by default) -->
                <div id="custom-period-container" class="custom-period-container">
                    <input type="datetime-local" id="dash-start" class="input-datetime" aria-label="Date de d√©but">
                    <span class="separator-text">√†</span>
                    <input type="datetime-local" id="dash-end" class="input-datetime" aria-label="Date de fin">
                    <button type="button" class="btn-small btn-go" onclick="loadCustomHistory()">Go</button>
                </div>

                <div class="trend-placeholder">
                    <canvas id="realtimeChart"></canvas>
                </div>
            </section>

            <section class="card summary-card">
                <h2>R√©sum√©</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Actives</span>
                        <span class="value big" id="sum-active">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Alertes (Seuil)</span>
                        <span class="value big warn" id="sum-warn">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Erreurs Com.</span>
                        <span class="value big err" id="sum-err">0</span>
                    </div>
                </div>
            </section>

        </main>

    </div>

    <!-- MODAL WARNING -->
    <div id="warning-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="warning-title" aria-describedby="warning-text">
        <div class="access-denied-content">
            <div class="access-denied-icon">‚ö†Ô∏è</div>
            <h2 id="warning-title" class="access-denied-title warning-title">Attention</h2>
            <p id="warning-text" class="access-denied-text">Message d'avertissement...</p>
            <button type="button" onclick="closeWarning()" class="btn-access-denied btn-warning-ok">OK</button>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000/api";
        let currentChart = null;
        let selectedVarId = null;
        let currentVarData = null; // Store variable info for chart thresholds

        function showWarning(msg) {
            document.getElementById("warning-text").textContent = msg;
            document.getElementById("warning-modal").style.display = "flex";
        }

        function closeWarning() {
            document.getElementById("warning-modal").style.display = "none";
        }

        // 1. Horloge
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').textContent = now.toLocaleTimeString('fr-FR');
            document.getElementById('clock-date').textContent = now.toLocaleDateString('fr-FR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. Gestion du Switch Mode (Simu / R√©el)
        async function toggleMode() {
            const isSimu = document.getElementById("mode-switch").checked;
            updateSwitchVisuals(isSimu);
            try {
                await fetch(`${API_URL}/mode`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ simulation: isSimu })
                });
            } catch (e) { console.error("Erreur switch mode", e); }
        }

        function updateSwitchVisuals(isSimu) {
            const label = document.getElementById("mode-label");
            if (isSimu) {
                label.textContent = "SIMULATION";
                label.style.color = "#ff4b4b"; // Rouge
            } else {
                label.textContent = "MODBUS R√âEL";
                label.style.color = "#2ecc71"; // Vert
            }
        }

        // 3. Boucle principale (Rafra√Æchissement Dashboard)
        async function updateDashboard() {
            const badge = document.getElementById("backend-badge");
            const tbody = document.getElementById("vars-body");

            try {
                // A. V√©rification connexion (Timeout court 1s)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1000);

                // On v√©rifie le mode en premier pour voir si le backend r√©pond
                const resMode = await fetch(`${API_URL}/mode`, { signal: controller.signal });
                clearTimeout(timeoutId);
                const dataMode = await resMode.json();

                // Si on est l√†, le backend est VIVANT
                if (badge.textContent !== "Backend OK") {
                    badge.textContent = "Backend OK";
                    badge.style.backgroundColor = "#2ecc71";
                }

                // Synchro du bouton switch si besoin
                const checkbox = document.getElementById("mode-switch");
                if (checkbox.checked !== dataMode.mode) {
                    checkbox.checked = dataMode.mode;
                    updateSwitchVisuals(dataMode.mode);
                }

                // B. R√©cup√©ration des donn√©es Dashboard
                const response = await fetch(`${API_URL}/dashboard`);
                const data = await response.json();

                tbody.innerHTML = "";

                let activeCount = 0;
                let warnCount = 0;
                let errCount = 0;

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="empty-message">Aucune variable active.</td></tr>`;
                }

                // C. Boucle sur chaque variable
                data.forEach(item => {
                    activeCount++;

                    let displayValue = "";
                    let statusClass = "ok";
                    let statusText = "OK";

                    // Cas 1 : Erreur de communication ou valeur nulle
                    if (item.valeur === null || item.valeur === -1) {
                        displayValue = "ERREUR";
                        statusClass = "err";
                        statusText = "TIMEOUT";
                        errCount++;
                    }
                    // Cas 2 : Bool√©en (TOR)
                    else if (item.type === "boolean") {
                        if (item.valeur == 1) {
                            displayValue = "MARCHE (1)";
                            statusClass = "ok";
                        } else {
                            displayValue = "ARR√äT (0)";
                            statusClass = "warn"; // Ou gris
                            statusText = "OFF";
                        }
                    }
                    // Cas 3 : Analogique (Nombre)
                    else {
                        let val = parseFloat(item.valeur);

                        // Formatage (D√©cimales + Unit√©)
                        displayValue = val.toFixed(item.decimals || 0);
                        if (item.unit) displayValue += " " + item.unit;

                        // --- LOGIQUE DES SEUILS (ALERTE) ---
                        if (item.seuil_max !== null && val > item.seuil_max) {
                            statusClass = "err";   // Rouge
                            statusText = "HAUT";
                            warnCount++;
                        }
                        else if (item.seuil_min !== null && val < item.seuil_min) {
                            statusClass = "warn";  // Orange
                            statusText = "BAS";
                            warnCount++;
                        }
                    }

                    // Cr√©ation de la ligne HTML
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                    <td class="var-name">${item.nom}</td>
                    <td class="var-ip">${item.ip}</td>
                    <td class="var-registre">${item.registre}</td>
                    <td class="var-value">${displayValue}</td>
                    <td><span class="pill ${statusClass}">${statusText}</span></td>
                `;

                    // Clic pour voir les d√©tails
                    tr.style.cursor = "pointer";
                    if (selectedVarId === item.id) {
                        tr.classList.add('row-selected');
                    }
                    tr.onclick = () => {
                        selectedVarId = item.id;
                        currentVarData = item; // Store for chart thresholds
                        updateDetail(item, displayValue);
                        loadHistoryForDashboard(60); // Default 1h
                    };
                    tbody.appendChild(tr);
                });

                // Mise √† jour des compteurs (KPI)
                document.getElementById("sum-active").textContent = activeCount;
                document.getElementById("sum-warn").textContent = warnCount;
                document.getElementById("sum-err").textContent = errCount;

            } catch (e) {
                console.error("Serveur d√©connect√©:", e);

                // Affichage Mode HORS LIGNE
                badge.textContent = "Backend OFF";
                badge.style.backgroundColor = "#ff4b4b";

                tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-message">
                        <span class="error-message">
                            ‚ö†Ô∏è CONNEXION PERDUE ‚ö†Ô∏è
                        </span><br>
                        <small class="error-subtext">Le serveur Node.js ne r√©pond pas.</small>
                    </td>
                </tr>
            `;
                // Reset KPIs
                document.getElementById("sum-active").textContent = "-";
                document.getElementById("sum-warn").textContent = "-";
                document.getElementById("sum-err").textContent = "-";
            }
        }

        // Affichage d√©tail (Carte de droite)
        function updateDetail(item, displayValue) {
            document.getElementById("rt-var-name").textContent = item.nom;
            document.getElementById("rt-value").textContent = displayValue;

            if (item.timestamp) {
                const dateObj = new Date(item.timestamp);
                document.getElementById("rt-timestamp").textContent = dateObj.toLocaleTimeString();
            } else {
                document.getElementById("rt-timestamp").textContent = "--:--:--";
            }
        }

        // --- CHARGEMENT HISTORIQUE DASHBOARD ---
        function toggleCustomPeriod() {
            const container = document.getElementById("custom-period-container");
            container.style.display = container.style.display === "flex" ? "none" : "flex";
        }

        async function loadCustomHistory() {
            if (!selectedVarId) return;
            const start = document.getElementById("dash-start").value;
            const end = document.getElementById("dash-end").value;

            if (!start || !end) {
                showWarning("Veuillez s√©lectionner une date de d√©but et de fin.");
                return;
            }

            const query = new URLSearchParams({
                variable_id: selectedVarId,
                start: start,
                end: end
            });

            try {
                const res = await fetch(`${API_URL}/history?${query}`);
                const data = await res.json();
                renderDashboardChart(data);
            } catch (e) { console.error(e); }
        }

        async function loadHistoryForDashboard(minutes) {
            if (!selectedVarId) return;

            // Masquer le custom si on clique sur un bouton rapide
            document.getElementById("custom-period-container").style.display = "none";

            const end = new Date();
            const start = new Date(end.getTime() - minutes * 60000);

            const query = new URLSearchParams({
                variable_id: selectedVarId,
                start: start.toISOString(),
                end: end.toISOString()
            });

            try {
                const res = await fetch(`${API_URL}/history?${query}`);
                const data = await res.json();
                renderDashboardChart(data);
            } catch (e) {
                console.error("Erreur historique dashboard:", e);
            }
        }

        function renderDashboardChart(data) {
            const ctx = document.getElementById('realtimeChart').getContext('2d');

            if (currentChart) {
                currentChart.destroy();
            }

            if (data.length === 0) return;

            const labels = data.map(d => new Date(d.timestamp));
            const values = data.map(d => d.valeur);

            // Configuration de base
            let config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentVarData ? currentVarData.nom : "Valeur",
                        data: values,
                        borderColor: '#11c5ff',
                        backgroundColor: 'rgba(17, 197, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0, // Plus propre pour le dashboard
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: { minute: 'HH:mm' }
                            },
                            grid: { color: '#1c2844' },
                            ticks: { color: '#9aa7c7', maxTicksLimit: 6 }
                        },
                        y: {
                            grid: { color: '#1c2844' },
                            ticks: { color: '#9aa7c7' }
                        }
                    },
                    plugins: {
                        legend: { display: false } // Pas besoin de l√©gende sur le dashboard
                    }
                }
            };

            // --- Sp√©cifique TOR (Digital) ---
            if (currentVarData && currentVarData.type === 'boolean') {
                config.data.datasets[0].stepped = true;
                config.options.scales.y.ticks.stepSize = 1;
                config.options.scales.y.min = 0;
                config.options.scales.y.max = 1.2;
                config.options.scales.y.ticks.callback = function (value) {
                    if (value === 0) return 'OFF';
                    if (value === 1) return 'ON';
                    return '';
                };
            }

            // --- Sp√©cifique Analogique (Seuils) ---
            if (currentVarData && currentVarData.type === 'float') {
                if (currentVarData.seuil_max) {
                    config.data.datasets.push({
                        label: 'Max',
                        data: new Array(data.length).fill(currentVarData.seuil_max),
                        borderColor: '#ff4b4b',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    });
                }
                if (currentVarData.seuil_min) {
                    config.data.datasets.push({
                        label: 'Min',
                        data: new Array(data.length).fill(currentVarData.seuil_min),
                        borderColor: '#f39c12',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    });
                }
            }

            currentChart = new Chart(ctx, config);
        }

        // Lancer la boucle (toutes les 2 secondes)
        setInterval(updateDashboard, 2000);
        updateDashboard(); // Premier appel imm√©diat
    </script>

</body>

</html>
