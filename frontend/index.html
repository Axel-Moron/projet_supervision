<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Supervision ‚Äì Variables process</title>
    <link rel="stylesheet" href="style-dashboard.css">

    <script>
        if (localStorage.getItem("loggedIn") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>
<style>
    /* Style du Switch */
    .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    
    /* Par d√©faut (Non coch√© = MODE R√âEL) -> On met du VERT */
    .slider { 
        position: absolute; cursor: pointer; 
        top: 0; left: 0; right: 0; bottom: 0; 
        background-color: #2ecc71; /* VERT pour le mode R√©el */
        -webkit-transition: .4s; transition: .4s; 
        border-radius: 34px; 
    }
    
    .slider:before { 
        position: absolute; content: ""; 
        height: 14px; width: 14px; 
        left: 2px; bottom: 2px; 
        background-color: white; 
        -webkit-transition: .4s; transition: .4s; 
        border-radius: 50%; 
    }

    /* Quand on coche (MODE SIMULATION) -> On met du ROUGE */
    input:checked + .slider { 
        background-color: #ff4b4b; /* ROUGE demand√© */
    } 
    
    input:focus + .slider { box-shadow: 0 0 1px #ff4b4b; }
    
    input:checked + .slider:before { 
        -webkit-transform: translateX(16px); 
        -ms-transform: translateX(16px); 
        transform: translateX(16px); 
    }
</style>
<body class="dash-body">

    <aside class="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">üß∞</span>
            <span class="sidebar-logo-text">SUPERVISION</span>
        </div>

        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item active">üìä <span>Temps r√©el</span></a>
            <a href="config.html" class="sidebar-item">‚öôÔ∏è <span>Param√©trage</span></a>
            <a href="historique.html" class="sidebar-item">üìÖ <span>Historique</span></a>
        </nav>

        <button class="sidebar-logout" onclick="logout()">D√©connexion</button>
    </aside>

    <div class="main-layout">

        <header class="topbar">
            <div>
                <h1>Supervision des variables process</h1>
                <p>TP ‚Äì D√©ploiement d‚Äôun SI (Node / MariaDB / Docker)</p>
            </div>
            <div class="topbar-right">
                <div class="topbar-badges" style="display: flex; align-items: center; gap: 10px;">
                    <span class="badge badge-ok">Backend OK</span>
                    <span class="badge badge-ok">MariaDB OK</span>
                    
                    <div style="display:flex; align-items:center; background:#0b172d; padding:2px 8px; border-radius:15px; border:1px solid #1c2844;">
                        <span id="mode-label" style="font-size:10px; margin-right:8px; color:#9aa7c7;">SIMULATION</span>
                        <label class="switch">
                            <input type="checkbox" id="mode-switch" checked onchange="toggleMode()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="topbar-clock">
                    <span id="clock-time">--:--</span>
                    <span id="clock-date">--/--/----</span>
                </div>
            </div>
        </header>

        <main class="grid grid-tp">

            <section class="card vars-card">
                <h2>Variables surveill√©es</h2>
                
                <table class="vars-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>IP automate</th>
                            <th>Registre</th>
                            <th>Fr√©q. (s)</th>
                            <th>Derni√®re valeur</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="vars-body">
                        <tr><td colspan="6" style="text-align:center;">Chargement...</td></tr>
                    </tbody>
                </table>

                <div class="vars-footer">
                    <button class="btn-link" onclick="window.location.href='config.html'">
                        ‚öôÔ∏è G√©rer les variables
                    </button>
                </div>
            </section>

            <section class="card realtime-card">
                <div class="realtime-header">
                    <div>
                        <h2>Temps r√©el ‚Äì <span id="rt-var-name">S√©lectionnez une variable</span></h2>
                        <p>Derni√®res 2 minutes (rafra√Æchissement p√©riodique c√¥t√© backend)</p>
                    </div>
                    <div class="rt-current">
                        <span class="label">Derni√®re valeur</span>
                        <span class="rt-value" id="rt-value">--</span>
                        <span class="rt-timestamp" id="rt-timestamp">--:--:--</span>
                    </div>
                </div>

                <div class="trend-placeholder">
                    <span>Graphique temps r√©el (Chart.js ici)</span>
                </div>
            </section>

            <section class="card summary-card">
                <h2>R√©sum√© supervision</h2>

                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Variables actives</span>
                        <span class="value big" id="sum-active">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Variables en seuil</span>
                        <span class="value big warn" id="sum-warn">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Variables en d√©faut</span>
                        <span class="value big err" id="sum-err">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Total mesures / h</span>
                        <span class="value big" id="sum-rate">--</span>
                    </div>
                </div>

                <div class="summary-footer">
                    <button class="btn-link" onclick="window.location.href='historique.html'">
                        üìÖ Voir historique & export CSV
                    </button>
                </div>
            </section>

        </main>

    </div>

<script>
    const API_URL = "http://localhost:3000/api";

    // 1. Mise √† jour de l'horloge
    function updateClock() {
        const now = new Date();
        document.getElementById('clock-time').textContent = now.toLocaleTimeString('fr-FR');
        document.getElementById('clock-date').textContent = now.toLocaleDateString('fr-FR');
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 2. Boucle de rafra√Æchissement des donn√©es (Toutes les 2 secondes)
    setInterval(updateDashboard, 2000);
    updateDashboard(); // Premier appel imm√©diat

    async function updateDashboard() {
        try {
            const response = await fetch(`${API_URL}/dashboard`);
            if(!response.ok) throw new Error("Erreur r√©seau");
            
            const data = await response.json();
            const tbody = document.getElementById("vars-body");
            tbody.innerHTML = ""; // On vide le tableau pour le reremplir

            // Compteurs pour les KPIs
            let activeCount = 0;
            let warnCount = 0; // Seuil d√©pass√©
            let errCount = 0;  // Erreur ou panne

            data.forEach(item => {
                activeCount++;
                
                // --- LOGIQUE D'AFFICHAGE (TOR vs ANALOGIQUE) ---
                let displayValue = item.valeur;
                let statusClass = "ok";
                let statusText = "OK";

                // Si c'est un bool√©en (Type d√©fini ou valeur 0/1 stricte)
                if (item.type === "boolean" || (item.valeur == 0 || item.valeur == 1 && item.valeur % 1 == 0)) {
                    if (item.valeur == 1) {
                        displayValue = "MARCHE";
                        statusClass = "ok";
                    } else {
                        displayValue = "ARR√äT";
                        statusClass = "warn"; // Orange pour arr√™t
                        statusText = "STOP";
                    }
                } 
                // Sinon c'est une valeur num√©rique (Temp√©rature, Pression...)
                else {
                    let val = parseFloat(item.valeur);
                    displayValue = val.toFixed(2); // Pas d'unit√© en dur ici, on laisse le nombre pur
                    
                    // Exemple de r√®gle m√©tier : Si > 80, c'est une alerte
                    if(val > 80) {
                        statusClass = "err";
                        statusText = "ALERTE";
                        warnCount++; 
                    }
                }

                // Cr√©ation de la ligne HTML
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.nom}</td>
                    <td>${item.ip}</td>
                    <td>${item.registre}</td>
                    <td>${item.frequence}</td>
                    <td style="font-weight:bold; color:#e5ecff;">${displayValue}</td>
                    <td><span class="pill ${statusClass}">${statusText}</span></td>
                `;
                
                // Clic pour afficher le d√©tail √† droite
                tr.onclick = () => updateDetail(item, displayValue);
                
                // Ajout au tableau
                tbody.appendChild(tr);
            });

            // Mise √† jour des KPIs (R√©sum√©)
            document.getElementById("sum-active").textContent = activeCount;
            document.getElementById("sum-warn").textContent = warnCount;
            document.getElementById("sum-err").textContent = errCount;
            // Estimation simple du d√©bit de donn√©es
            document.getElementById("sum-rate").textContent = activeCount * (60/5) * 60; // Environ

        } catch (e) {
            console.error("Erreur connexion backend:", e);
        }
    }

    // 3. Mise √† jour de la carte "Temps r√©el" (D√©tail)
    function updateDetail(item, displayValue) {
        document.getElementById("rt-var-name").textContent = item.nom;
        document.getElementById("rt-value").textContent = displayValue;
        
        if(item.timestamp) {
            const dateObj = new Date(item.timestamp);
            document.getElementById("rt-timestamp").textContent = "√† " + dateObj.toLocaleTimeString();
        } else {
            document.getElementById("rt-timestamp").textContent = "--:--:--";
        }
    }

    // 4. Fonction de d√©connexion
    async function logout() {
        try {
            await fetch("http://localhost:3000/api/auth/logout", { 
                method: "POST",
                credentials: "include"
            });
        } catch(e) { console.error(e); }
        
        localStorage.removeItem("loggedIn");
        window.location.href = "login.html";
    }
    // Gestion du mode (Simu / R√©el)
    async function toggleMode() {
        const isSimu = document.getElementById("mode-switch").checked;
        const label = document.getElementById("mode-label");
        
        // Mettre √† jour l'interface imm√©diatement
        if(isSimu) {
            label.textContent = "SIMULATION";
            label.style.color = "#ff4b4b"; // ROUGE
        } else {
            label.textContent = "MODBUS R√âEL";
            label.style.color = "#2ecc71"; // VERT
        }

        // ... suite du code (fetch) inchang√©e ...
    }

    // Au chargement, v√©rifier l'√©tat actuel
    (async () => {
        try {
            const res = await fetch(`${API_URL}/mode`);
            const data = await res.json();
            const checkbox = document.getElementById("mode-switch");
            checkbox.checked = data.mode;
            
            // D√©clencher visuellement
            if(data.mode) {
                document.getElementById("mode-label").textContent = "SIMULATION";
                document.getElementById("mode-label").style.color = "#ff4b4b"; // ROUGE
            } else {
                document.getElementById("mode-label").textContent = "MODBUS R√âEL";
                document.getElementById("mode-label").style.color = "#2ecc71"; // VERT
            }
        } catch(e) {}
    })();
</script>

</body>
</html>