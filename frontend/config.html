<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Param√©trage des variables</title>
    <link rel="stylesheet" href="style-dashboard.css">

    <script>
        if (localStorage.getItem("loggedIn") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>

<body class="dash-body">

<aside class="sidebar">
    <div class="sidebar-logo">
        <span class="sidebar-logo-icon">üß∞</span>
        <span class="sidebar-logo-text">SUPERVISION</span>
    </div>

    <nav class="sidebar-menu">
        <a href="index.html" class="sidebar-item">üìä <span>Temps r√©el</span></a>
        <a href="config.html" class="sidebar-item active">‚öôÔ∏è <span>Param√©trage</span></a>
        <a href="historique.html" class="sidebar-item">üìÖ <span>Historique</span></a>
    </nav>

    <button class="sidebar-logout" onclick="logout()">D√©connexion</button>
</aside>

<div class="main-layout">

<header class="topbar">
    <div>
        <h1>Param√©trage des variables</h1>
        <p>Ajoute, modifie ou supprime des variables √† superviser</p>
    </div>
    <div class="topbar-clock">
        <span id="clock-time">--:--</span>
        <span id="clock-date">--/--/----</span>
    </div>
</header>

<main class="config-container">

    <section class="card config-card">
        <h2>Liste des variables</h2>

        <table class="vars-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>IP automate</th>
                    <th>Registre</th>
                    <th>Fr√©quence (s)</th>
                    <th>Actif</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody id="config-body">
                <tr><td colspan="6" style="text-align:center;">Chargement des donn√©es...</td></tr>
            </tbody>
        </table>

        <div class="config-footer">
            <button class="btn-add" onclick="openForm()">‚ûï Ajouter une variable</button>
        </div>
    </section>

    <section class="card form-card" id="form-card" style="display:none;">
        <h2 id="form-title">Ajouter une variable</h2>

        <label>Nom de la variable</label>
        <input type="text" id="var-nom">

        <label>IP automate</label>
        <input type="text" id="var-ip">

        <label>Registre / Adresse</label>
        <input type="text" id="var-registre">

        <label>Fr√©quence (sec)</label>
        <input type="number" id="var-freq">

        <label>Actif</label>
        <select id="var-actif">
            <option value="1">Oui</option>
            <option value="0">Non</option>
        </select>
        <label>Type de donn√©e</label>
        <select id="var-type">
            <option value="float">Analogique (Ex: Temp√©rature)</option>
            <option value="boolean">TOR (Ex: Bouton / Moteur)</option>
        </select>
        <div class="form-buttons">
            <button class="btn-save">üíæ Enregistrer</button>
            <button class="btn-cancel" onclick="closeForm()">Annuler</button>
        </div>
    </section>

</main>

</div>

<script>
    const API_URL = "http://localhost:3000/api";

    // Chargement initial
    loadVariables();

    // Gestion de l'horloge (ajout√© car pr√©sent dans ton HTML mais sans script)
    function updateClock() {
        const now = new Date();
        document.getElementById('clock-time').textContent = now.toLocaleTimeString('fr-FR');
        document.getElementById('clock-date').textContent = now.toLocaleDateString('fr-FR');
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loadVariables() {
        try {
            const response = await fetch(`${API_URL}/variables`);
            const variables = await response.json();
            const tbody = document.getElementById("config-body");
            tbody.innerHTML = ""; // On efface le message "Chargement..."

            if(variables.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Aucune variable configur√©e.</td></tr>';
                return;
            }

            variables.forEach(v => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${v.nom}</td>
                    <td>${v.ip_automate}</td>
                    <td>${v.registre}</td>
                    <td>${v.frequence}</td>
                    <td><span class="pill ${v.actif ? 'ok' : 'err'}">${v.actif ? 'ON' : 'OFF'}</span></td>
                    <td>
                        <button class="btn-small delete-btn" onclick="deleteVar(${v.id})">Supprimer</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error("Erreur chargement variables:", e);
        }
    }

    // Sauvegarder nouvelle variable
    document.querySelector(".btn-save").addEventListener("click", async () => {
        const data = {
            nom: document.getElementById("var-nom").value,
            ip_automate: document.getElementById("var-ip").value,
            registre: document.getElementById("var-registre").value,
            type: document.getElementById("var-type").value,
            frequence: document.getElementById("var-freq").value,
            actif: document.getElementById("var-actif").value === "1"
        };

        try {
            await fetch(`${API_URL}/variables`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            closeForm();
            loadVariables(); // Recharger le tableau
        } catch (e) {
            console.error("Erreur sauvegarde", e);
        }
    });

    // Suppression d'une variable
    async function deleteVar(id) {
        if(!confirm("Voulez-vous vraiment supprimer cette variable ?")) return;
        
        try {
            await fetch(`${API_URL}/variables/${id}`, { method: "DELETE" });
            loadVariables();
        } catch (e) {
            console.error("Erreur suppression", e);
        }
    }

    // D√©connexion
    async function logout() {
        try {
            await fetch("http://localhost:3000/api/auth/logout", { 
                method: "POST",
                credentials: "include"
            });
        } catch(e) { console.error(e); }
    
        localStorage.removeItem("loggedIn");
        window.location.href = "login.html";
    }

    // Fonctions utilitaires d'interface
    function openForm() { document.getElementById("form-card").style.display = "flex"; }
    function closeForm() { document.getElementById("form-card").style.display = "none"; }
</script>

</body>
</html>