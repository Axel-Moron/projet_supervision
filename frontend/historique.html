<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision ‚Äì Historique</title>
    <link rel="stylesheet" href="style-dashboard.css?v=1.5">
    <script src="auth.js?v=1.5"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date Adapter for Chart.js (optional but good for time scales) -->
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body class="dash-body">

    <aside class="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">üß∞</span>
            <span class="sidebar-logo-text">SUPERVISION</span>
        </div>

        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item">üìä <span>Temps r√©el</span></a>
            <a href="config.html" class="sidebar-item">‚öôÔ∏è <span>Param√©trage</span></a>
            <a href="historique.html" class="sidebar-item active">üìÖ <span>Historique</span></a>
        </nav>
    </aside>

    <div class="main-layout">

        <header class="topbar">
            <div>
                <h1>Historique et Visualisation</h1>
                <p>Analysez les donn√©es pass√©es avec des graphiques interactifs</p>
            </div>

            <div class="topbar-right">
                <!-- Username injected by auth.js -->
                <div class="topbar-clock">
                    <span id="clock-time">--:--</span>
                    <span id="clock-date">--/--/----</span>
                </div>
            </div>
        </header>

        <main class="config-container history-main-layout">

            <!-- FILTRES -->
            <section class="card form-card">
                <h2>Param√®tres de recherche</h2>
                <div class="filters-container">

                    <div class="filter-group-large">
                        <label for="filter-var">Variables (Ctrl+Click pour plusieurs)</label>
                        <select id="filter-var" name="filter-var" multiple class="filter-var-select">
                            <!-- Options remplies par JS -->
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Plage rapide</label>
                        <div class="quick-ranges">
                            <button class="btn-small" onclick="setRange(5)">5 min</button>
                            <button class="btn-small" onclick="setRange(60)">1 h</button>
                            <button class="btn-small" onclick="setRange(240)">4 h</button>
                            <button class="btn-small" onclick="setRange(1440)">24 h</button>
                            <button class="btn-small" onclick="setRange(10080)">1 Sem</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="filter-start">D√©but</label>
                        <input type="datetime-local" id="filter-start" name="filter-start">
                    </div>

                    <div class="filter-group">
                        <label for="filter-end">Fin</label>
                        <input type="datetime-local" id="filter-end" name="filter-end">
                    </div>

                    <button class="btn-search" onclick="searchData()">üîç Afficher</button>
                    <button class="btn-export" onclick="exportCSV()">üì• CSV</button>
                </div>
            </section>

            <!-- GRAPHIQUE -->
            <section class="card chart-card-height">
                <h2>Graphique</h2>
                <div class="chart-container">
                    <canvas id="historyChart"></canvas>
                </div>
            </section>

            <!-- TABLEAU -->
            <section class="card config-card">
                <h2>Donn√©es brutes (<span id="res-count">0</span> mesures)</h2>
                <div class="table-scroll-container">
                    <table class="vars-table">
                        <thead>
                            <tr>
                                <th>Date / Heure</th>
                                <th>Variable</th>
                                <th>Valeur</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr>
                                <td colspan="3" class="empty-message">S√©lectionnez une variable et une plage de temps.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </main>

    </div>

    <!-- MODAL WARNING (Rempla√ßant alert) -->
    <div id="warning-modal" class="modal-overlay">

        <div class="access-denied-content">
            <div class="access-denied-icon">‚ö†Ô∏è</div>
            <h2 class="access-denied-title warning-title">Attention</h2>
            <p id="warning-text" class="access-denied-text">Message d'avertissement...</p>
            <button onclick="closeWarning()" class="btn-warning-ok">OK</button>

        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000/api";
        let currentChart = null;
        let variablesList = [];

        // --- 0. Gestion Modal Warning ---
        function showWarning(msg) {
            document.getElementById("warning-text").textContent = msg;
            document.getElementById("warning-modal").style.display = "flex";
        }

        function closeWarning() {
            document.getElementById("warning-modal").style.display = "none";
        }

        // --- 1. Initialisation ---
        async function loadVars() {
            try {
                const res = await fetch(`${API_URL}/variables`);
                variablesList = await res.json();
                const select = document.getElementById("filter-var");

                variablesList.forEach(v => {
                    const opt = document.createElement("option");
                    opt.value = v.id;
                    opt.textContent = v.nom;
                    select.appendChild(opt);
                });

                // Par d√©faut : 1 heure
                setRange(60);
            } catch (e) {
                console.error("Erreur chargement variables:", e);
            }
        }
        loadVars();

        // --- 2. Gestion des plages ---
        function setRange(minutes) {
            const end = new Date();
            const start = new Date(end.getTime() - minutes * 60000);

            // Format pour datetime-local: YYYY-MM-DDTHH:mm
            const format = (d) => {
                const pad = (n) => n < 10 ? '0' + n : n;
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            document.getElementById("filter-end").value = format(end);
            document.getElementById("filter-start").value = format(start);
        }

        // --- 3. Recherche et Affichage ---
        async function searchData() {
            const select = document.getElementById("filter-var");
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);

            if (selectedOptions.length === 0) {
                showWarning("Veuillez s√©lectionner au moins une variable.");
                return;
            }

            const varIds = selectedOptions.join(',');
            const start = document.getElementById("filter-start").value;
            const end = document.getElementById("filter-end").value;

            const query = new URLSearchParams({ variable_id: varIds, start, end });

            try {
                const res = await fetch(`${API_URL}/history?${query}`);
                const data = await res.json();

                updateTable(data);
                updateChart(data, selectedOptions);

            } catch (e) { console.error(e); }
        }

        function updateTable(data) {
            document.getElementById("res-count").textContent = data.length;
            const tbody = document.getElementById("history-body");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3' class='empty-message'>Aucune donn√©e sur cette p√©riode</td></tr>";
                return;
            }

            // Afficher les 100 derni√®res mesures max dans le tableau pour ne pas surcharger
            const displayData = data.slice().reverse().slice(0, 100);

            displayData.forEach(d => {
                const tr = document.createElement("tr");
                const dateFmt = new Date(d.timestamp).toLocaleString();
                const varName = d.Variable ? d.Variable.nom : 'Inconnue';
                tr.innerHTML = `<td>${dateFmt}</td><td>${varName}</td><td><strong>${d.valeur}</strong></td>`;
                tbody.appendChild(tr);
            });
        }

        function updateChart(data, selectedVarIds) {
            const ctx = document.getElementById('historyChart').getContext('2d');

            if (currentChart) {
                currentChart.destroy();
            }

            if (data.length === 0) return;

            // Grouper les donn√©es par variable
            const datasets = [];
            const colors = ['#11c5ff', '#2ecc71', '#f39c12', '#9b59b6', '#e74c3c'];

            selectedVarIds.forEach((varId, index) => {
                const variable = variablesList.find(v => v.id == varId);
                const varData = data.filter(d => d.variable_id == varId);

                if (varData.length === 0) return;

                const color = colors[index % colors.length];

                const dataset = {
                    label: variable.nom,
                    data: varData.map(d => ({ x: new Date(d.timestamp), y: d.valeur })),
                    borderColor: color,
                    backgroundColor: color + '20', // Opacit√©
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: false,
                    tension: 0.1
                };

                // Sp√©cifique TOR
                if (variable.type === 'boolean') {
                    dataset.stepped = true;
                }

                datasets.push(dataset);
            });

            // --- RESTAURATION DES SEUILS (ALERTE) ---
            // Uniquement si une seule variable est s√©lectionn√©e pour √©viter la confusion
            if (selectedVarIds.length === 1) {
                const variable = variablesList.find(v => v.id == selectedVarIds[0]);
                if (variable && variable.type === 'float') {
                    if (variable.seuil_max) {
                        datasets.push({
                            label: 'Seuil Max',
                            data: new Array(data.length).fill(variable.seuil_max),
                            borderColor: '#ff4b4b',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        });
                    }
                    if (variable.seuil_min) {
                        datasets.push({
                            label: 'Seuil Min',
                            data: new Array(data.length).fill(variable.seuil_min),
                            borderColor: '#f39c12',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        });
                    }
                }
            }

            // Configuration de base
            let config = {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: { minute: 'HH:mm' }
                            },
                            grid: { color: '#1c2844' },
                            ticks: { color: '#9aa7c7' }
                        },
                        y: {
                            grid: { color: '#1c2844' },
                            ticks: { color: '#9aa7c7' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e5ecff' } }
                    }
                }
            };

            currentChart = new Chart(ctx, config);
        }

        // --- 4. Export CSV ---
        function exportCSV() {
            const select = document.getElementById("filter-var");
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);

            if (selectedOptions.length === 0) {
                showWarning("Veuillez s√©lectionner au moins une variable.");
                return;
            }

            const varIds = selectedOptions.join(',');
            const start = document.getElementById("filter-start").value;
            const end = document.getElementById("filter-end").value;

            const query = new URLSearchParams({ variable_id: varIds, start, end });
            window.location.href = `${API_URL}/export?${query}`;
        }

        // Horloge
        setInterval(() => {
            const now = new Date();
            document.getElementById("clock-time").textContent = now.toLocaleTimeString();
            document.getElementById("clock-date").textContent = now.toLocaleDateString();
        }, 1000);
    </script>

</body>

</html>