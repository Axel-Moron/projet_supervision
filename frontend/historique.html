<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision ‚Äì Historique</title>
    <link rel="stylesheet" href="style-dashboard.css?v=1.2">
    <script src="auth.js"></script>
</head>

<body class="dash-body">

    <aside class="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">üß∞</span>
            <span class="sidebar-logo-text">SUPERVISION</span>
        </div>

        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item">üìä <span>Temps r√©el</span></a>
            <a href="config.html" class="sidebar-item">‚öôÔ∏è <span>Param√©trage</span></a>
            <a href="historique.html" class="sidebar-item active">üìÖ <span>Historique</span></a>
        </nav>

        <button class="sidebar-logout" onclick="logout()">D√©connexion</button>
    </aside>

    <div class="main-layout">

        <header class="topbar">
            <div>
                <h1>Historique et Exports</h1>
                <p>Consultez les anciennes mesures et exportez-les en CSV</p>
            </div>

            <div class="topbar-right">
                <!-- Username injected by auth.js -->
                <div class="topbar-clock">
                    <span id="clock-time">--:--</span>
                    <span id="clock-date">--/--/----</span>
                </div>
            </div>
        </header>

        <main class="config-container">

            <section class="card form-card">
                <h2>Filtres de recherche</h2>
                <div class="filters-container">

                    <div class="filter-group-large">
                        <label for="filter-var">Variable</label>
                        <select id="filter-var" name="filter-var">
                            <option value="">Toutes les variables</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-start">Date d√©but</label>
                        <input type="date" id="filter-start" name="filter-start">
                    </div>

                    <div class="filter-group">
                        <label for="filter-end">Date fin</label>
                        <input type="date" id="filter-end" name="filter-end">
                    </div>

                    <button class="btn-search" onclick="searchData()">üîç Rechercher</button>
                    <button class="btn-export" onclick="exportCSV()">üì• Export CSV</button>
                </div>
            </section>

            <section class="card config-card">
                <h2>R√©sultats (<span id="res-count">0</span> mesures)</h2>
                <table class="vars-table">
                    <thead>
                        <tr>
                            <th>Date / Heure</th>
                            <th>Variable</th>
                            <th>Valeur</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr>
                            <td colspan="3" class="empty-message">Lancer une recherche...</td>
                        </tr>
                    </tbody>
                </table>
            </section>

        </main>

    </div>

    <script>
        const API_URL = "http://localhost:3000/api";
        let currentData = [];

        // 1. Charger la liste des variables au d√©marrage
        async function loadVars() {
            try {
                const res = await fetch(`${API_URL}/variables`);
                const vars = await res.json();
                const select = document.getElementById("filter-var");
                vars.forEach(v => {
                    const opt = document.createElement("option");
                    opt.value = v.id;
                    opt.textContent = v.nom;
                    select.appendChild(opt);
                });

                // Dates par d√©faut (aujourd'hui)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById("filter-start").value = today;
                document.getElementById("filter-end").value = today;
            } catch (e) {
                console.error("Erreur chargement variables:", e);
            }
        }
        loadVars();

        // 2. Rechercher les donn√©es
        async function searchData() {
            const varId = document.getElementById("filter-var").value;
            const start = document.getElementById("filter-start").value;
            const end = document.getElementById("filter-end").value;

            const query = new URLSearchParams({ variable_id: varId, start, end });

            try {
                const res = await fetch(`${API_URL}/history?${query}`);
                currentData = await res.json();

                document.getElementById("res-count").textContent = currentData.length;
                const tbody = document.getElementById("history-body");
                tbody.innerHTML = "";

                if (currentData.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3' class='empty-message'>Aucune donn√©e trouv√©e</td></tr>";
                    return;
                }

                currentData.forEach(d => {
                    const tr = document.createElement("tr");
                    const dateFmt = new Date(d.timestamp).toLocaleString();
                    tr.innerHTML = `
                    <td>${dateFmt}</td>
                    <td>${d.Variable ? d.Variable.nom : 'Inconnue'}</td>
                    <td><strong>${d.valeur}</strong></td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        // 3. Exporter en CSV (Via Backend)
        function exportCSV() {
            const varId = document.getElementById("filter-var").value;
            const start = document.getElementById("filter-start").value;
            const end = document.getElementById("filter-end").value;

            const query = new URLSearchParams({ variable_id: varId, start, end });

            // D√©clenche le t√©l√©chargement direct via le navigateur
            window.location.href = `${API_URL}/export?${query}`;
        }

        function logout() {
            localStorage.removeItem("loggedIn");
            window.location.href = "login.html";
        }

        // Horloge
        setInterval(() => {
            const now = new Date();
            document.getElementById("clock-time").textContent = now.toLocaleTimeString();
            document.getElementById("clock-date").textContent = now.toLocaleDateString();
        }, 1000);
    </script>

</body>

</html>